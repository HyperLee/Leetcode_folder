# LeetCode 3623 - Count Number of Trapezoids I

📌 這份 README.md 針對 `leetcode_3623/Program.cs` 的解法做詳細說明，包括問題定義、核心想法、數學公式推導、時間與空間複雜度分析、測試用例，以及如何在本地建構與執行程式。

---

## 問題描述

給定一組平面上的離散點 `points`（每個點為 `[x, y]`），要求統計能夠構成「水平梯形」的數量，並對答案取模 `10^9 + 7`。

- 梯形的兩條平行邊必須為水平線段（也就是位於不同的 y 座標），且每條平行邊由相同 y 值的兩個點確定。
- 一個水平梯形由選擇兩個不同的 y 層（y1, y2），在 y1 層選取兩個不同的點作為一條水平邊，在 y2 層選取兩個不同的點作為另一條水平邊形成。

---

## 核心想法（直觀）

1. 把所有點依照 `y` 座標分群：對於每個 `y`，計算該層的點數 `p_y`。
2. 在同一 `y` 層選兩個不同點能構成的水平邊數為 `C(p_y, 2) = p_y * (p_y - 1) / 2`，記為 `E_y`（每個層的「邊數」）。
3. 任意選兩個不同層 `y1`、`y2`（y1 != y2），兩條邊 `E_y1`、`E_y2` 的任意組合都會形成一個水平梯形，數量為 `E_y1 * E_y2`。
4. 因此問題等同於計算所有不同 y 層配對的 `E_i * E_j` 的總和（其中 i < j）。

---

## 公式推導與優化

- 直接按公式定義計算：
  - 給所有不同的 y 層的邊數列表 `E_1, E_2, ..., E_k`。
  - 所需數量為 `sum_{1 <= i < j <= k} E_i * E_j`。

- 我們可以使用兩種等價的計算方式：

  1) 前綴和累加（程式中使用）
     - 令 `sum` 為已處理層 (previous layers) 的 `E` 值之和（初始為 0）。
     - 當處理當前層 `E` 時，該層與之前所有層能構成的梯形數為 `E * sum`，累加到結果 `res`。
     - 更新 `sum += E` 並繼續。
     - 此方法只需 O(k) 的時間計算所有層之間的配對數，避免了 O(k^2) 的顯式兩層循環。

  2) 代數化簡（快速推導）
     - 設 `S = sum_{i=1..k} E_i`（總邊數），
     - 我們要求 `sum_{i<j} E_i * E_j = (S^2 - sum_{i} E_i^2) / 2`。
     - 這個式子可以直接使用，但要注意過程中需要避免整數溢出或做模運算的細節（模數為 1e9 + 7 不是偶數，且 2 的乘法逆元可以用 `(MOD + 1)/2` 或直接採用累加法繼續安全計算）。

- 在實作時，前綴和累加法比較直觀且方便做模運算，故在 `Program.cs` 中採用此方法並對 `1e9+7` 取模。

---

## 邊界條件與注意事項

- 若某個 `y` 層的點數 `p_y < 2`，則 `E_y = 0`，該層不能形成水平邊。
- 若整體僅有一個或零個不同的 `y` 層（或所有 `E_y = 0`），則結果為 0。
- 使用 64 位整數（`long`）中間計算以避免溢位，最後再對 `MOD` 取模，並將回傳值 cast 為 `int`。

---

## 時間與空間複雜度分析

- 時間複雜度：O(n + k)，其中 n 為點數，k 為不同的 `y` 層數。
  - 統計每層點數需要 O(n)
  - 遍歷各層計算 `E_y` 並累計結果需要 O(k)

- 空間複雜度：O(k)，用於存放每個不同 `y` 的點數映射 (Dictionary)

---

## 程式碼說明（關鍵片段）

程式核心在於：

```csharp
// 以 Dictionary<int,int> 統計每個 y 層的點數 p_y
// edge = C(p_y, 2)
// res += edge * sum; // sum 表示之前層的所有 edge 之和
// sum += edge;
```

完整實作：請參考 `leetcode_3623/Program.cs`。

---

## 範例測試案例

- 範例 1：
  - 輸入：兩行 (y=0, y=1)，每行 3 個點
  - 每行 `E = C(3,2) = 3`，共 `3 * 3 = 9` 個水平梯形
  - 程式輸出：9

- 範例 2：
  - 輸入：單行 (y=0) 3 個點
  - 沒有兩個不同行，因此結果為 0
  - 程式輸出：0

- 範例 3：
  - 輸入：y=0 有 2 個點 (E=1)，y=1 有 3 個點 (E=3)
  - 結果為 `1 * 3 = 3`
  - 程式輸出：3

---

## 在本地建構與執行

若使用 dotnet，請在 repo 根目錄執行：

```bash
# 建構
dotnet build leetcode_3623/leetcode_3623.csproj -c Debug

# 執行
dotnet run --project leetcode_3623/leetcode_3623.csproj --no-build -c Debug
```

上述腳本會在 `Program.cs` 中執行三個測試樣例並輸出結果。

---

## 延伸與其他想法 💡

- 若需要統計更複雜的梯形（非水平、任意角度），則問題會變得更複雜，需要考慮斜邊與線段共線性等條件，並可能需用到計算直線斜率或向量運算的技巧。
- 若想要使用代數式 ` (S^2 - sum E_i^2) / 2 `，則需要額外注意模運算下的除法（乘以 2 的乘法逆元）。在實作時要小心模數為奇數時（本題 MOD = 1e9+7）如何正確處理。

---

## 結語 ✅

此解法基於簡單的組合數學與哈希統計，具有線性時間複雜度與良好可擴展性，適用於 LeetCode 3623 類型問題："水平梯形計數"。如果你想要我額外補上「代數化簡實作」，或把此解法改寫成另一種語言（例如 Python、Java），請告訴我！

---

(檔案生成器：本 README.md 由 Copilot 生成，提供作為詳細解法與數學推導的參考。)
