# LeetCode 3625: 統計梯形的數目 II

[![.NET](https://img.shields.io/badge/.NET-10.0-512BD4?style=flat-square&logo=dotnet)](https://dotnet.microsoft.com/)
[![C#](https://img.shields.io/badge/C%23-14-239120?style=flat-square&logo=csharp)](https://docs.microsoft.com/dotnet/csharp/)
[![LeetCode](https://img.shields.io/badge/LeetCode-3625-FFA116?style=flat-square&logo=leetcode)](https://leetcode.cn/problems/count-number-of-trapezoids-ii/)

使用雜湊表與幾何數學方法解決 LeetCode 3625「統計梯形的數目 II」問題。

## 題目說明

給定一組 2D 平面上的點，計算可以形成**梯形**的四元組數量。

**梯形定義**：

- 恰好有一對邊平行（斜率相同但不共線）
- 不能是平行四邊形

## 解題思路

### 核心概念

本題使用**雜湊表 + 幾何數學**的方法：

1. **平行線段識別**：相同斜率但不同截距的線段為平行線段
2. **平行四邊形排除**：平行四邊形的兩條對角線交於同一中點，透過中點識別並排除

### 資料結構

| 雜湊表 | 鍵 (Key) | 值 (Value) | 用途 |
|:------|:---------|:-----------|:-----|
| `slopeToIntercept` | 斜率 k | 截距列表 | 找出平行線段對 |
| `midToSlope` | 中點編碼 | 斜率列表 | 識別平行四邊形 |

## 數學公式

### 斜率計算

$$k = \frac{y_2 - y_1}{x_2 - x_1}$$

> [!NOTE]
> 當 $x_2 = x_1$ 時（垂直線），使用特殊值 `MOD = 1e9 + 7` 表示斜率。

### 截距計算

$$b = y_1 - k \cdot x_1 = \frac{y_1 \cdot dx - x_1 \cdot dy}{dx}$$

其中 $dx = x_1 - x_2$，$dy = y_1 - y_2$

### 中點編碼

$$mid = (x_1 + x_2) \times 10000 + (y_1 + y_2)$$

> [!IMPORTANT]
> 乘以 10000 是為了確保不同中點產生唯一的編碼值。

### 結果計算

$$梯形數量 = \sum_{斜率相同} (不同截距的配對數) - \sum_{中點相同} (不同斜率的配對數)$$

## 名詞解釋
本段逐一說明專案中常用的幾個幾何名詞（斜率、截距、中點編碼），並以範例與實作注意事項補充。

### 斜率（Slope）
- 定義：直線的傾斜程度。
- 公式：k = (y2 - y1) / (x2 - x1)。若 x2 == x1（垂直線），分母為 0，程式需特殊處理。
- 範例：點 A(0,0) 與 B(2,1) → k = (1 - 0) / (2 - 0) = 0.5。
- 程式說明：原始做法以 double 表達斜率；建議改用整數 pair (dy/g, dx/g)（g = gcd(|dy|, |dx|）來避免浮點誤差與雜湊鍵碰撞。

### 截距（Intercept）
- 定義：非垂直直線與 y 軸相交的 y 值（y = kx + b 中的 b）。
- 公式：b = y1 - k * x1（非垂直線）。
- 範例：A(0,0) 與 B(2,1)，k = 0.5 → b = 0 - 0.5 * 0 = 0。
- 程式說明：垂直線通常用 x 值表示；建議使用整數化的標準式 (A,B,C) 以避免浮點檢查共線問題。

### 中點編碼（Midpoint Encoding）
- 定義：線段中點 M = ((x1 + x2)/2, (y1 + y2)/2)。可用 (x1+x2, y1+y2) 的整數 pair 表示中點，避免除以 2。
- 範例：A(0,0) 與 B(2,2) → 中點 (1,1)，用和 (2,2) 表示。
- 原始做法：程式將 (x1+x2, y1+y2) 編成 mid = (x1 + x2) * 10000.0 + (y1 + y2)；此寫法可能導致精度或碰撞問題。
- 建議：改用 `ValueTuple<int,int>` 當 dictionary key：`(x1+x2, y1+y2)` 或 `"xsum:ysum"` 字串格式，ValueTuple 效能最好。

### 實務重點摘要
- 斜率、截距與中點三者是演算法的關鍵，需要整數化與規範化來避免精度與碰撞風險。
- 統計時使用 `long` 計數並確保平行四邊形扣除時乘以 2（因為一個平行四邊形會在平行邊的配對數中被計算兩次）。


## 範例推演

### 輸入範例

```text
points = [[0,0], [1,1], [1,0], [2,0]]
```

### 步驟 1：計算所有線段的斜率、截距和中點

| 線段 | 點 1 | 點 2 | 斜率 k | 截距 b | 中點編碼 |
|:-----|:-----|:-----|:-------|:-------|:---------|
| L1 | (0,0) | (1,1) | 1 | 0 | 10001 |
| L2 | (0,0) | (1,0) | 0 | 0 | 10000 |
| L3 | (0,0) | (2,0) | 0 | 0 | 20000 |
| L4 | (1,1) | (1,0) | MOD | 1 | 20001 |
| L5 | (1,1) | (2,0) | -1 | 2 | 30001 |
| L6 | (1,0) | (2,0) | 0 | 0 | 30000 |

### 步驟 2：依斜率分組

```text
slopeToIntercept:
  k=0   → [0, 0, 0]  (L2, L3, L6 都是水平線)
  k=1   → [0]
  k=MOD → [1]
  k=-1  → [2]
```

### 步驟 3：計算平行線段配對

對於 `k=0`，有三條線段都是截距 0：

- 相同截距的線段屬於同一條直線，不能組成梯形
- 此例中所有水平線都共線，無法配對

### 步驟 4：扣除平行四邊形

檢查中點相同但斜率不同的線段對，將其從結果中扣除。

### 最終結果

此範例中，所有水平線 (k=0) 的線段都共線（截距都是 0），無法組成梯形。

```text
梯形數量 = 0
```

### 範例推演 B：平行四邊形（對照組）

以下範例是一個平行四邊形（兩組對邊互相平行），示範演算法如何在計算平行線段配對後，再利用中點資訊排除平行四邊形的影響。

### 輸入範例

```text
points = [[0,0], [2,0], [3,1], [1,1]]
```

### 步驟 1：計算所有線段的斜率、截距和中點

| 線段 | 點 1 | 點 2 | 斜率 k | 截距 b | 中點編碼 |
|:-----|:-----|:-----|:-------|:-------|:---------|
| L1 | (0,0) | (2,0) | 0 | 0 | 20000 |
| L2 | (0,0) | (3,1) | 1/3 | 0 | 30001 |
| L3 | (0,0) | (1,1) | 1 | 0 | 10001 |
| L4 | (2,0) | (3,1) | 1 | -2 | 50001 |
| L5 | (2,0) | (1,1) | -1 | 2 | 30001 |
| L6 | (3,1) | (1,1) | 0 | 1 | 40002 |

### 步驟 2：依斜率分組（slopeToIntercept）

```text
slopeToIntercept:
  k=0     → [0, 1]       (L1, L6)
  k=1     → [0, -2]      (L3, L4)
  k=1/3   → [0]          (L2)
  k=-1    → [2]          (L5)
```

對於 k=0 與 k=1 各有一對不同截距的線段，因此初步計算的平行線段配對數為 2（兩組候選）。

### 步驟 3：扣除平行四邊形（midToSlope）

在這個輸入中，AC 與 BD 是兩條對角線，且中點相同（中點編碼 30001），因此會被辨識為平行四邊形的對角線：

```text
midToSlope:
  mid=30001 → [1/3, -1]  (A-C 的斜率與 B-D 的斜率)
```

相同中點但不同斜率的線段對會被視為平行四邊形的特徵，因此要從結果中扣除對應的配對數量（此處為 1）。

### 最終結果

```text
初步平行配對數 = 2
扣除平行四邊形數 = 1
最終梯形數量 = 2 - 1 = 1
```

註：此範例展示演算法如何偵測到「平行四邊形」的存在，並從初步計數中扣除相應配對數，作為與沒有梯形的 `範例推演` 的對照組。

## 複雜度分析

| 項目 | 複雜度 | 說明 |
|:-----|:-------|:-----|
| 時間複雜度 | $O(n^2)$ | 遍歷所有點對 |
| 空間複雜度 | $O(n^2)$ | 儲存所有線段資訊 |

## 快速開始

### 環境需求

- [.NET 10 SDK](https://dotnet.microsoft.com/download)

### 執行程式

```bash
# 建構專案
dotnet build

# 執行程式
dotnet run --project leetcode_3625/leetcode_3625.csproj
```

### 預期輸出

```text
測試範例 1: 0 個梯形
測試範例 2: 3 個梯形
測試範例 3: 1 個梯形
測試範例 4: 0 個梯形 (空陣列)
測試範例 5: 0 個梯形 (三角形)

所有測試完成！
```

## 程式碼結構

```text
leetcode_3625/
├── leetcode_3625.csproj    # 專案檔
├── Program.cs              # 主程式與解題實作
└── README.md               # 本文件
```

## 關鍵程式碼片段

```csharp
// 計算斜率與截距
if (x2 == x1)
{
    k = MOD;     // 垂直線使用特殊值
    b = x1;
}
else
{
    k = (double)(y2 - y1) / (x2 - x1);
    b = (double)(y1 * dx - x1 * dy) / dx;
}

// 中點編碼
double mid = (x1 + x2) * 10000.0 + (y1 + y2);
```

## 相關題目

- [LeetCode 3623: 統計梯形的數目 I](https://leetcode.cn/problems/count-number-of-trapezoids-i/) - 本題的簡化版本
- [LeetCode 149: 直線上最多的點數](https://leetcode.cn/problems/max-points-on-a-line/) - 使用斜率判斷共線

## 參考資料

- [力扣官方題解](https://leetcode.cn/problems/count-number-of-trapezoids-ii/solutions/3844283/tong-ji-ti-xing-de-shu-mu-ii-by-leetcode-6uwd/)
